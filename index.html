<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cyberspace Luck Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarpanch:wght@400;700;900&family=Orbitron:wght@400;900&family=JetBrains+Mono:wght@400;800&family=Roboto+Mono:ital,wght@0,700;1,700&family=Inter:wght@400;700&display=swap');

        :root {
            --cyber-blue: #0088ff;
            --cyber-bg: #01040a; 
            --navy-relic: #001a4d;
            --navy-glow: rgba(0, 43, 128, 0.8);
            --relic-blue: #001f5e;
            --warp-theme: rgba(0, 255, 255, 0.15);
            --trans-theme: rgba(255, 255, 150, 0.15);
            --neon-glow: #00f2ff;
        }

        /* Fixed UI Scaling for all devices (Targeting 60% of standard mobile size) */
        html {
            font-size: 14px;
        }

        body {
            background-color: var(--cyber-bg);
            color: white;
            font-family: 'Sarpanch', sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            position: fixed;
        }

        /* Force UI to scale down on smaller screens to match requested 60% look */
        @media (max-width: 1024px) {
            #ui-hud, #ui-bottom, #ui-center, #leaderboard-overlay, #auth-overlay {
                transform: scale(0.75);
                transform-origin: center;
                width: 133.33% !important; /* Counteract scale to fill width */
                left: -16.66% !important;
            }
            #ui-hud { transform-origin: top center; top: 0; }
            #ui-bottom { transform-origin: bottom center; bottom: 0; }
            #leaderboard-overlay, #auth-overlay { transform-origin: center; }
        }

        video::-webkit-media-controls { display: none !important; }
        video::-webkit-media-controls-enclosure { display: none !important; }
        video::-webkit-media-controls-panel { display: none !important; }

        #orientation-guard {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }

        @media (max-width: 932px) and (orientation: portrait) {
            #orientation-guard { display: flex; }
        }

        #entry-overlay {
            position: fixed; inset: 0; background: black; z-index: 600;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease; text-align: center; padding: 20px;
        }

        #auth-overlay {
            position: fixed; inset: 0; background: rgba(1, 4, 10, 0.95); z-index: 650;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease; text-align: center; padding: 20px;
            backdrop-filter: blur(10px);
        }

        .auth-container {
            width: 90%; max-width: 400px;
            background: rgba(0, 10, 30, 0.9);
            border: 2px solid rgba(0, 242, 255, 0.3);
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.2);
            padding: 30px;
        }

        .auth-title {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 24px;
            color: #00f2ff;
            text-shadow: 0 0 10px #00f2ff;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .auth-subtitle {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            color: rgba(0, 242, 255, 0.7);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 30px;
        }

        .auth-option {
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid rgba(0, 242, 255, 0.2);
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .auth-option:hover {
            border-color: rgba(0, 242, 255, 0.5);
            background: rgba(0, 30, 60, 0.9);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
            transform: translateY(-2px);
        }

        .auth-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .auth-text {
            flex: 1;
            text-align: left;
        }

        .auth-option-title {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 16px;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 5px;
        }

        .auth-option-desc {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.4;
        }

        #cinematic-overlay {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black; 
            z-index: 500;
            display: none; 
            opacity: 0; 
            transition: opacity 0.4s ease-in-out; 
            cursor: pointer;
            overflow: hidden;
        }

        #cinematic-video { 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%; 
            min-height: 100%; 
            width: auto;
            height: auto;
            object-fit: cover; 
            background-color: black; 
            pointer-events: none; 
        }

        #skip-hint {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.4); font-size: 14px; text-transform: uppercase;
            letter-spacing: 0.2em; pointer-events: none; z-index: 510;
        }

        .cyber-grid-container {
            position: absolute; inset: 0; perspective: 1000px; overflow: hidden; z-index: 0;
            background: radial-gradient(circle at 50% 50%, #001a33 0%, #01040a 100%);
            transition: opacity 0.5s ease;
        }

        .cyber-grid {
            position: absolute; width: 300%; height: 300%; top: -100%; left: -100%;
            background-image: 
                linear-gradient(to right, rgba(0, 242, 255, 0.15) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 242, 255, 0.15) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: rotateX(55deg);
            animation: grid-scroll 2s linear infinite, grid-glow 4s ease-in-out infinite alternate;
        }

        @keyframes grid-scroll {
            0% { transform: rotateX(55deg) translateY(0); }
            100% { transform: rotateX(55deg) translateY(60px); }
        }

        @keyframes grid-glow {
            from { filter: drop-shadow(0 0 2px var(--neon-glow)) opacity(0.5); }
            to { filter: drop-shadow(0 0 8px var(--neon-glow)) opacity(0.8); }
        }

        .digit {
            position: absolute; color: #00f2ff; font-family: 'JetBrains Mono', monospace;
            font-size: 18px; font-weight: bold; pointer-events: none;
            text-shadow: 0 0 10px #00f2ff; animation: rise 4s linear forwards;
        }

        @keyframes rise {
            0% { transform: translateY(110vh); opacity: 0; }
            10% { opacity: 0.7; }
            90% { opacity: 0.7; }
            100% { transform: translateY(-10vh); opacity: 0; }
        }

        .illusionary-relic {
            font-family: 'Roboto Mono', monospace; font-weight: 700; font-style: italic;
            text-transform: lowercase; color: var(--relic-blue);
            text-shadow: 0 0 10px #000a20, 0 0 30px var(--relic-blue), 0 0 50px rgba(0, 31, 94, 0.3);
            letter-spacing: -0.02em; -webkit-text-stroke: 1px rgba(0, 162, 255, 0.4);
            paint-order: stroke fill;
        }

        .flicker-char { display: inline-block; transition: color 0.15s ease; }
        .flicker-white { 
            color: #ffffff !important; 
            text-shadow: 0 0 20px #ffffff, 0 0 40px var(--relic-blue) !important;
            -webkit-text-stroke: 1px rgba(255, 255, 255, 0.8) !important;
        }

        .roll-btn {
            background: #000000; border: 1px solid #ffffff; color: #ffffff;
            font-family: 'Orbitron', sans-serif; font-weight: 900; letter-spacing: 0.2em;
            text-shadow: 0 0 8px #ffffff; box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
            transition: all 0.1s; cursor: pointer; text-transform: uppercase;
            width: 280px; /* Fixed width for both buttons */
            max-width: 90%;
        }

        .roll-btn:hover { box-shadow: 0 0 30px rgba(255, 255, 255, 0.4); background: #111111; border-color: #00f2ff; text-shadow: 0 0 12px #00f2ff; }
        .roll-btn:active { transform: scale(0.92); background: #ffffff; color: #000000; text-shadow: none; }

        .potion-node {
            border: 1px solid #1e293b; transition: all 0.2s ease;
            background: rgba(0, 0, 0, 0.8); display: flex; align-items: center;
            gap: 12px; padding: 10px 14px; width: 100%;
        }

        .node-warp:hover { border-color: #00ffff; background: var(--warp-theme); box-shadow: 0 0 15px rgba(0, 255, 255, 0.2); }
        .node-trans:hover { border-color: #ffffaa; background: var(--trans-theme); box-shadow: 0 0 15px rgba(255, 255, 170, 0.2); }

        .auto-btn { background: rgba(0, 0, 0, 0.8); border: 1px solid #334155; transition: all 0.3s; cursor: pointer; }
        .auto-btn.active { border-color: #22c55e; box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); background: rgba(21, 128, 61, 0.1); }

        .custom-input {
            background: rgba(0, 10, 30, 0.8); border: 1px solid var(--navy-relic);
            color: #ffffff; font-family: 'JetBrains Mono', monospace; outline: none; width: 100%;
        }

        .scanline {
            width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0, 242, 255, 0.02) 50%);
            background-size: 100% 4px; position: absolute; top: 0; left: 0; pointer-events: none; z-index: 5;
        }

        .hud-label { font-family: 'Inter', sans-serif; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; }
        
        /* Flash Animations */
        .glitch-flash { animation: flash 0.15s ease-out; }
        .trans-flash { animation: flash-yellow 0.15s ease-out; }
        
        @keyframes flash { 0% { background: #00f2ff; opacity: 0.3; } 100% { background: transparent; opacity: 0; } }
        @keyframes flash-yellow { 0% { background: #ffffaa; opacity: 0.4; } 100% { background: transparent; opacity: 0; } }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 3px; background: rgba(0, 242, 255, 0.2); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #00f2ff; cursor: pointer; margin-top: -4.5px; box-shadow: 0 0 8px #00f2ff;
        }

        .ui-hidden { opacity: 0 !important; pointer-events: none !important; transition: opacity 0.5s ease; }
        #ui-center { z-index: 550; }
        .reset-indicator { font-family: 'Inter', sans-serif; font-size: 8px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-top: 4px; }

        #roll-log {
            font-family: 'JetBrains Mono', monospace; font-size: 11px; color: rgba(255, 255, 255, 0.8);
            pointer-events: none; z-index: 40; text-transform: uppercase;
            line-height: 1.6; margin-top: 12px;
        }
        .log-entry { opacity: 0; transform: translateY(-3px); animation: log-slide 0.3s forwards; }
        @keyframes log-slide { to { opacity: 1; transform: translateY(0); } }
        
        /* Leaderboard Styles */
        #leaderboard-overlay {
            position: fixed; inset: 0; background: rgba(1, 4, 10, 0.95); z-index: 700;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease; text-align: center; padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .leaderboard-container {
            width: 90%; max-width: 800px; height: 80vh;
            background: rgba(0, 10, 30, 0.9);
            border: 2px solid rgba(0, 242, 255, 0.3);
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.2);
            display: flex; flex-direction: column;
        }
        
        .leaderboard-header {
            background: rgba(0, 20, 40, 0.95);
            border-bottom: 1px solid rgba(0, 242, 255, 0.3);
            padding: 15px 20px;
            text-align: center;
        }
        
        .leaderboard-title {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 24px;
            color: #00f2ff;
            text-shadow: 0 0 10px #00f2ff;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .leaderboard-subtitle {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            color: rgba(0, 242, 255, 0.7);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        
        .leaderboard-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            margin-bottom: 8px;
            background: rgba(0, 20, 40, 0.6);
            border: 1px solid rgba(0, 242, 255, 0.1);
            transition: all 0.2s ease;
        }
        
        .leaderboard-entry:hover {
            border-color: rgba(0, 242, 255, 0.4);
            background: rgba(0, 30, 60, 0.7);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.1);
        }
        
        .entry-rank {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 18px;
            color: #00f2ff;
            min-width: 40px;
        }
        
        .entry-name {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 400;
            font-size: 14px;
            color: #ffffff;
            flex: 1;
            text-align: left;
            padding-left: 20px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .entry-rolls {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
            font-size: 16px;
            color: #ffffff;
            min-width: 120px;
            text-align: right;
        }
        
        .entry-rolls::after {
            content: " rolls";
            font-size: 10px;
            color: rgba(0, 242, 255, 0.7);
            margin-left: 5px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .leaderboard-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(0, 242, 255, 0.3);
            background: rgba(0, 20, 40, 0.95);
        }
        
        .leaderboard-note {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 10px;
        }

        /* Back Button Styles */
        .back-btn {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .back-btn:hover {
            border-color: #00f2ff;
            background: rgba(0, 242, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }

        .back-btn svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-between">
    <div id="orientation-guard">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#00f2ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-6 animate-bounce"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
        <p class="text-white text-base md:text-lg font-bold tracking-widest uppercase">Rotate to Landscape</p>
    </div>

    <div id="entry-overlay">
        <button onclick="showAuth()" class="roll-btn px-10 py-4 text-lg md:text-xl border-2">Start Simulator</button>
        <button onclick="showLeaderboard()" class="mt-6 roll-btn px-10 py-4 text-lg md:text-xl border-2">Leaderboard</button>
        <p class="mt-4 text-[10px] md:text-xs text-white/60 tracking-[0.2em] uppercase font-bold">Made by @tlq_h</p>
    </div>

    <div id="auth-overlay">
        <div class="auth-container">
            <div class="auth-title">How would you like to play?</div>
            <div class="auth-subtitle">Choose your play mode</div>
            
            <div class="auth-option" onclick="playAsGuest()">
                <div class="auth-icon">ðŸ‘¤</div>
                <div class="auth-text">
                    <div class="auth-option-title">Play as Guest</div>
                    <div class="auth-option-desc">Play without an account. Your progress will be saved locally but won't appear on leaderboard.</div>
                </div>
            </div>
            
            <div class="auth-option" onclick="loginWithDiscord()">
                <div class="auth-icon" style="color: #5865F2;">ðŸ…­</div>
                <div class="auth-text">
                    <div class="auth-option-title">Sign in with Discord</div>
                    <div class="auth-option-desc">Sign in with Discord to save your progress and appear on global leaderboard.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="leaderboard-overlay">
        <div class="leaderboard-container">
            <div class="leaderboard-header">
                <div class="leaderboard-title">Leaderboard</div>
                <div class="leaderboard-subtitle">Lowest rolls to roll illusionary</div>
                <div class="leaderboard-subtitle" style="font-size: 10px; color: rgba(0, 242, 255, 0.5); margin-top: 5px;">
                    Status: <span id="current-user-display">Not signed in</span>
                </div>
            </div>
            <div class="leaderboard-list" id="leaderboard-list">
                <!-- Leaderboard entries will be loaded from server -->
            </div>
            <div class="leaderboard-footer">
                <button onclick="hideLeaderboard()" class="roll-btn px-8 py-3 text-sm">Back to Simulator</button>
                <div class="leaderboard-note">* Only Discord accounts appear on leaderboard *</div>
            </div>
        </div>
    </div>

    <div id="cinematic-overlay" ondblclick="skipCinematic()">
        <video id="cinematic-video" playsinline webkit-playsinline muted preload="auto" x5-video-player-type="h5-page" x5-video-orientation="landscape">
            <source src="https://pomf2.lain.la/f/touuuxy3.mp4" type="video/mp4">
        </video>
        <div id="skip-hint">Double Click to Skip</div>
    </div>

    <div id="flash" class="fixed inset-0 pointer-events-none z-[60]"></div>
    
    <div class="cyber-grid-container" id="grid-container">
        <div class="cyber-grid"></div>
        <div class="scanline"></div>
    </div>

    <div id="ui-hud" class="fixed top-0 left-0 w-full grid grid-cols-3 p-2 md:p-4 z-10 items-start">
        <div class="flex flex-col">
            <div class="border-l-[2px] border-cyan-500/30 pl-3 md:pl-4 bg-black/60 backdrop-blur-md py-1.5 shadow-[0_0_15px_rgba(0,242,255,0.1)]">
                <div class="text-[8px] md:text-[10px] text-cyan-400/50 hud-label mb-0.5">rolls</div>
                <div id="rolls-display" class="text-lg md:text-3xl font-black text-white leading-tight">0</div>
            </div>
            <!-- Chronological Log (Limited to 4 entries) -->
            <div id="roll-log"></div>
        </div>
        <div class="flex flex-col items-center justify-center -mt-1">
            <button onclick="resetProgress()" class="px-6 md:px-12 py-2 md:py-3 bg-black/40 border-[1px] border-red-900/50 text-[9px] md:text-[12px] font-bold text-red-900/80 uppercase tracking-widest hover:bg-red-900 hover:text-white transition-colors">RESET</button>
            <div class="reset-indicator">Press R to reset</div>
        </div>
        <div class="border-r-[2px] border-blue-900/40 pr-3 md:pr-4 text-right bg-black/60 backdrop-blur-md py-1.5 shadow-[0_0_15px_rgba(0,31,94,0.1)]">
            <div class="text-[8px] md:text-[10px] text-blue-400/60 hud-label mb-0.5">illusionary count</div>
            <div id="hits-display" class="text-lg md:text-3xl font-black text-[#0088ff] drop-shadow-[0_0_8px_rgba(0,136,255,0.5)]">0</div>
        </div>
    </div>

    <div id="ui-center" class="fixed inset-0 flex flex-col items-center justify-center text-center px-4 pointer-events-none">
        <div id="display-window" class="opacity-0 transition-all duration-300 transform scale-95 w-full pointer-events-none">
            <div id="main-output" class="text-3xl md:text-7xl w-full"></div>
            <div id="odds-container" class="mt-4 md:mt-8 flex flex-col items-center justify-center gap-1 opacity-0 transition-opacity duration-700">
                <div id="odds-text" class="text-[10px] md:text-2xl font-black text-[#001f5e] tracking-[0.25em] uppercase" style="-webkit-text-stroke: 0.5px rgba(0, 31, 94, 0.3);">1 IN 10,000,000</div>
            </div>
        </div>
    </div>

    <!-- Bottom UI with Aligned Roll Button -->
    <div id="ui-bottom" class="fixed bottom-0 left-0 w-full p-2 md:p-4 z-20 flex items-end justify-between pointer-events-none">
        <!-- Left Side Column -->
        <div class="flex flex-col gap-2.5 w-40 md:w-64 pointer-events-auto">
            <!-- Back Button (Arrow) -->
            <button onclick="returnToHomepage()" class="back-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            
            <button id="cinematic-toggle-btn" onclick="toggleCinematicMode()" class="auto-btn active flex items-center justify-between px-3 md:px-5 py-2 md:py-3.5 w-full mb-0.5">
                <div class="flex flex-col text-left">
                    <span class="text-[9px] md:text-[14px] font-bold text-white uppercase leading-none">Cutscenes</span>
                    <span id="cine-status" class="text-[7px] md:text-[11px] text-green-400 uppercase leading-none mt-1">On</span>
                </div>
                <div id="cine-led" class="w-2 md:w-3 h-2 md:h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div>
            </button>
            <button onclick="runSim(2000)" class="potion-node node-warp py-2.5 md:py-4">
                <img src="https://i.ibb.co/wrdVKqFG/warp.png" class="w-5 h-5 md:w-8 md:h-8 opacity-80">
                <div class="flex flex-col text-left">
                    <span class="text-[9px] md:text-[14px] font-bold text-cyan-200 uppercase leading-none">Warp Potion</span>
                    <span class="text-[7px] md:text-[11px] text-cyan-500 leading-none mt-1">2,000 skips</span>
                </div>
            </button>
            <button onclick="runSim(20000, 'trans')" class="potion-node node-trans py-2.5 md:py-4">
                <img src="https://i.ibb.co/KpwmGGG9/trans.png" class="w-5 h-5 md:w-8 md:h-8 opacity-80">
                <div class="flex flex-col text-left">
                    <span class="text-[9px] md:text-[14px] font-bold text-yellow-200 uppercase leading-none">Transcendent</span>
                    <span class="text-[7px] md:text-[11px] text-yellow-500 leading-none mt-1">20,000 skips</span>
                </div>
            </button>
        </div>

        <!-- Center: Aligned Roll Button -->
        <div class="flex flex-col items-center pointer-events-auto w-[35%] md:w-auto pb-0.5 md:pb-1">
            <button onclick="runSim(1)" class="roll-btn w-full md:w-auto px-6 md:px-20 h-10 md:h-16 text-sm md:text-2xl">ROLL</button>
        </div>

        <!-- Right Side Column -->
        <div class="flex flex-col gap-2.5 w-40 md:w-64 pointer-events-auto">
            <div class="bg-black/60 backdrop-blur-md border-[1px] border-cyan-500/20 p-2 md:p-3 flex flex-col gap-2 rounded-md shadow-[0_0_15_rgba(0,242,255,0.05)]">
                <div class="flex items-center gap-1.5">
                    <span class="text-[6px] md:text-[9px] text-cyan-400/60 uppercase font-bold w-4">BGM</span>
                    <input type="range" id="bgm-vol" min="0" max="100" value="50" oninput="updateBGMVolume(this.value)" class="w-full h-1">
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="text-[6px] md:text-[9px] text-cyan-400/60 uppercase font-bold w-4">SFX</span>
                    <input type="range" id="sfx-vol" min="0" max="100" value="50" oninput="updateSFXVolume(this.value)" class="w-full h-1">
                </div>
            </div>
            <button id="auto-roll-btn" onclick="toggleAutoRoll()" class="auto-btn flex items-center justify-between px-3 md:px-5 py-2 md:py-3.5 w-full">
                <div class="flex flex-col text-left">
                    <span class="text-[9px] md:text-[14px] font-bold text-white uppercase leading-none">Auto Roll</span>
                    <span id="auto-status" class="text-[7px] md:text-[11px] text-white/40 uppercase leading-none mt-1">Disabled</span>
                </div>
                <div id="auto-led" class="w-2 md:w-3 h-2 md:h-3 rounded-full bg-slate-700"></div>
            </button>
            <div class="potion-node bg-black/60 flex-col !items-stretch p-2 md:p-3.5 border-cyan-500/10">
                <div class="flex gap-2">
                    <input type="number" id="custom-roll-amount" placeholder="Skips..." class="custom-input p-1.5 text-[9px] md:text-[13px] h-8 md:h-12 px-3">
                    <button onclick="handleCustomRoll()" class="bg-cyan-500/10 border-[1px] border-cyan-500/30 px-2 text-[8px] md:text-[11px] font-bold leading-tight uppercase hover:bg-cyan-500 hover:text-black transition-colors">SKIP</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rolls = 0, hits = 0;
        const ODDS = 10000000;
        let flickerInterval = null, autoRollInterval = null, isAutoRolling = false, isCinematicPlaying = false, isCinematicEnabled = true, unlocked = false, isShowingIllusionary = false; 
        let sfxVolume = 0.5, bgmVolume = 0.5;
        let logEntries = [];
        
        // User authentication state
        let currentUser = null;
        let isGuest = true;
        
        // Leaderboard data - Will be fetched from your backend
        let leaderboardData = [];
        
        // Discord OAuth2 Configuration - UPDATED FOR YOUR REPOSITORY
        const DISCORD_CLIENT_ID = '1455676135739228182';
        const DISCORD_REDIRECT_URI = encodeURIComponent('https://tlqtlq.github.io/Cyberspace-Luck-Simulator-TEST/auth/discord-callback.html');
        const DISCORD_SCOPE = encodeURIComponent('identify');
        const DISCORD_AUTH_URL = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${DISCORD_REDIRECT_URI}&response_type=code&scope=${DISCORD_SCOPE}&prompt=none`;
        
        const illusionarySFX = new Audio('https://pomf2.lain.la/f/vvei5e1c.mov');
        const bgm = new Audio('https://pomf2.lain.la/f/jfj7608j.ogg');
        const video = document.getElementById('cinematic-video');
        const cinematicOverlay = document.getElementById('cinematic-overlay');
        const rollLog = document.getElementById('roll-log');

        illusionarySFX.preload = 'auto'; bgm.preload = 'auto'; bgm.loop = true;

        // Load user from localStorage on page load
        function loadUserFromStorage() {
            const savedUser = localStorage.getItem('cyberspaceUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                currentUser = userData;
                isGuest = userData.isGuest;
                updateUserDisplay();
            }
        }

        function updateUserDisplay() {
            const displayElement = document.getElementById('current-user-display');
            if (displayElement) {
                if (currentUser && !isGuest) {
                    displayElement.textContent = `Signed in as ${currentUser.username}`;
                } else {
                    displayElement.textContent = 'Not signed in';
                }
            }
        }

        async function unlockMedia() {
            if (unlocked) return;
            bgm.volume = 0; bgm.play().then(() => { bgm.pause(); bgm.volume = bgmVolume; }).catch(() => {});
            illusionarySFX.volume = 0; illusionarySFX.play().then(() => { illusionarySFX.pause(); illusionarySFX.currentTime = 0; illusionarySFX.volume = sfxVolume; }).catch(() => {});
            video.removeAttribute('controls'); video.controls = false; video.muted = true; video.style.display = 'block';
            try { await video.play(); video.pause(); video.currentTime = 0; } catch (e) {}
            unlocked = true;
        }

        function showAuth() {
            document.getElementById('auth-overlay').style.display = 'flex';
            setTimeout(() => { 
                document.getElementById('auth-overlay').style.opacity = '1'; 
            }, 10);
        }

        function hideAuth() {
            document.getElementById('auth-overlay').style.opacity = '0';
            setTimeout(() => { 
                document.getElementById('auth-overlay').style.display = 'none'; 
            }, 500);
        }

        function playAsGuest() {
            // Set user as guest
            currentUser = { username: 'Guest', isGuest: true };
            isGuest = true;
            localStorage.setItem('cyberspaceUser', JSON.stringify(currentUser));
            updateUserDisplay();
            
            hideAuth();
            startSimulator();
        }

        function loginWithDiscord() {
            // Redirect to Discord OAuth2 authorization page in a popup
            const width = 500;
            const height = 700;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;
            
            const popup = window.open(
                DISCORD_AUTH_URL,
                'Discord Login',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`
            );
            
            // Check for popup block
            if (!popup || popup.closed || typeof popup.closed === 'undefined') {
                alert('Pop-up blocked! Please allow pop-ups for this site to sign in with Discord.');
                return;
            }
            
            // Set up message listener for popup callback
            const messageListener = function(event) {
                // Check origin for security
                if (event.data && event.data.type === 'DISCORD_AUTH_COMPLETE') {
                    const userData = event.data.user;
                    currentUser = userData;
                    isGuest = false;
                    localStorage.setItem('cyberspaceUser', JSON.stringify(userData));
                    updateUserDisplay();
                    
                    // Clean up listener
                    window.removeEventListener('message', messageListener);
                    
                    // Close popup
                    if (popup && !popup.closed) {
                        popup.close();
                    }
                    
                    hideAuth();
                    startSimulator();
                }
            };
            
            window.addEventListener('message', messageListener, false);
            
            // Fallback check for popup closing
            const checkPopup = setInterval(function() {
                if (popup.closed) {
                    clearInterval(checkPopup);
                    window.removeEventListener('message', messageListener);
                }
            }, 500);
        }

        function startSimulator() {
            unlockMedia();
            document.getElementById('entry-overlay').style.opacity = '0';
            setTimeout(() => { 
                document.getElementById('entry-overlay').style.display = 'none'; 
                bgm.play().catch(() => {}); 
            }, 500);
        }

        function showLeaderboard() {
            // Show loading state
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<div class="text-center py-20"><div class="text-cyan-400 text-lg mb-4">Loading leaderboard...</div></div>';
            
            document.getElementById('leaderboard-overlay').style.display = 'flex';
            setTimeout(() => { 
                document.getElementById('leaderboard-overlay').style.opacity = '1'; 
                // Fetch leaderboard data
                fetchLeaderboardData();
            }, 10);
        }

        function hideLeaderboard() {
            document.getElementById('leaderboard-overlay').style.opacity = '0';
            setTimeout(() => { 
                document.getElementById('leaderboard-overlay').style.display = 'none'; 
            }, 500);
        }

        function returnToHomepage() {
            // Stop auto-rolling if active
            if (isAutoRolling) {
                toggleAutoRoll();
            }
            
            // Stop any active cinematic
            if (isCinematicPlaying) {
                skipCinematic();
            }
            
            // Reset the game state
            resetProgress();
            
            // Show the main entry overlay
            document.querySelectorAll('#ui-hud, #ui-bottom, #grid-container').forEach(el => el.classList.add('ui-hidden'));
            
            setTimeout(() => {
                document.getElementById('entry-overlay').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('entry-overlay').style.opacity = '1';
                    // Hide the simulator UI elements
                    document.querySelectorAll('#ui-hud, #ui-bottom, #grid-container').forEach(el => el.classList.remove('ui-hidden'));
                    document.querySelectorAll('#ui-hud, #ui-bottom, #grid-container').forEach(el => el.style.display = 'none');
                }, 50);
            }, 300);
            
            // Pause BGM
            bgm.pause();
            bgm.currentTime = 0;
        }

        async function fetchLeaderboardData() {
            try {
                // For demo, use localStorage data
                // In production, fetch from your backend: fetch('https://your-backend.com/api/leaderboard')
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Check if we have any locally stored submissions
                const localSubmissions = JSON.parse(localStorage.getItem('cyberspaceSubmissions') || '[]');
                
                if (localSubmissions.length === 0) {
                    // No data yet
                    leaderboardData = [];
                    renderLeaderboard();
                    return;
                }
                
                // Process submissions into leaderboard format
                const userMap = new Map();
                
                localSubmissions.forEach(submission => {
                    if (!userMap.has(submission.userId)) {
                        userMap.set(submission.userId, {
                            username: submission.username,
                            bestRoll: submission.rolls,
                            totalHits: 1,
                            userId: submission.userId,
                            latestDate: submission.timestamp
                        });
                    } else {
                        const userData = userMap.get(submission.userId);
                        if (submission.rolls < userData.bestRoll) {
                            userData.bestRoll = submission.rolls;
                        }
                        userData.totalHits++;
                        if (submission.timestamp > userData.latestDate) {
                            userData.latestDate = submission.timestamp;
                        }
                    }
                });
                
                // Convert to array and sort by bestRoll (lowest first)
                leaderboardData = Array.from(userMap.values())
                    .map((user, index) => ({
                        rank: index + 1,
                        name: user.username,
                        rolls: user.bestRoll,
                        hits: user.totalHits,
                        userId: user.userId,
                        date: user.latestDate.split('T')[0],
                        isCurrentUser: (currentUser && !isGuest && currentUser.discordId === user.userId)
                    }))
                    .sort((a, b) => a.rolls - b.rolls)
                    .slice(0, 100);
                
                // Reassign ranks after sorting
                leaderboardData.forEach((entry, index) => {
                    entry.rank = index + 1;
                });
                
                renderLeaderboard();
                
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = '<div class="text-center py-20"><div class="text-red-400 text-lg mb-4">Error loading leaderboard</div><div class="text-white/50 text-sm">Please try again later</div></div>';
            }
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            
            if (leaderboardData.length === 0) {
                // Show message for empty leaderboard
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-center py-20';
                emptyMessage.innerHTML = `
                    <div class="text-cyan-400 text-lg mb-4">Leaderboard is empty</div>
                    <div class="text-white/50 text-sm">
                        ${!isGuest ? 'Be the first to roll an illusionary!' : 'Sign in with Discord and roll an illusionary to appear here!'}
                    </div>
                `;
                list.appendChild(emptyMessage);
                return;
            }
            
            leaderboardData.forEach(entry => {
                const entryElement = document.createElement('div');
                entryElement.className = 'leaderboard-entry';
                if (entry.isCurrentUser) {
                    entryElement.style.borderColor = 'rgba(0, 242, 255, 0.6)';
                    entryElement.style.background = 'rgba(0, 40, 80, 0.8)';
                    entryElement.style.boxShadow = '0 0 15px rgba(0, 242, 255, 0.3)';
                }
                entryElement.innerHTML = `
                    <div class="entry-rank">#${entry.rank}</div>
                    <div class="entry-name">${entry.name} ${entry.isCurrentUser ? ' (You)' : ''}</div>
                    <div class="entry-rolls">${entry.rolls.toLocaleString()}</div>
                `;
                list.appendChild(entryElement);
            });
        }

        function addLogEntry(hitIndex, rollAt) {
            logEntries.push({ index: hitIndex, roll: rollAt.toLocaleString() });
            // LIMITED TO 4 ENTRIES
            if (logEntries.length > 4) logEntries.shift();
            rollLog.innerHTML = logEntries.map(entry => `<div class="log-entry">#${entry.index} illusionary at ${entry.roll} rolls.</div>`).join('');
            
            // If user is authenticated with Discord (not guest), submit to leaderboard
            if (!isGuest && currentUser) {
                submitToLeaderboard(rollAt, hitIndex);
            }
        }

        function submitToLeaderboard(rolls, hitIndex) {
            // Save locally for now
            const leaderboardEntry = {
                userId: currentUser.discordId,
                username: currentUser.username,
                rolls: rolls,
                hitIndex: hitIndex,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage
            let submissions = JSON.parse(localStorage.getItem('cyberspaceSubmissions') || '[]');
            submissions.push(leaderboardEntry);
            localStorage.setItem('cyberspaceSubmissions', JSON.stringify(submissions));
            
            console.log(`Leaderboard submission saved: ${currentUser.username} got illusionary #${hitIndex} at ${rolls} rolls`);
        }

        function toggleCinematicMode() {
            isCinematicEnabled = !isCinematicEnabled;
            const btn = document.getElementById('cinematic-toggle-btn'), status = document.getElementById('cine-status'), led = document.getElementById('cine-led');
            if (isCinematicEnabled) {
                btn.classList.add('active'); status.innerText = "On";
                status.classList.replace('text-white/40', 'text-green-400');
                led.className = "w-2 md:w-3 h-2 md:h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
            } else {
                btn.classList.remove('active'); status.innerText = "Off";
                status.classList.replace('text-green-400', 'text-white/40');
                led.className = "w-2 md:w-3 h-2 md:h-3 rounded-full bg-slate-700 shadow-none";
            }
        }

        function skipCinematic() { if (isCinematicPlaying) { video.pause(); video.dispatchEvent(new Event('ended')); } }

        function triggerCinematic() {
            if (isCinematicPlaying) return;
            if (!isCinematicEnabled) { showIllusionaryTitle(); return; }
            isCinematicPlaying = true; bgm.pause();
            document.querySelectorAll('#ui-hud, #ui-bottom, #grid-container').forEach(el => el.classList.add('ui-hidden'));
            cinematicOverlay.style.display = 'block';
            setTimeout(async () => {
                cinematicOverlay.style.opacity = '1'; video.muted = false; video.volume = sfxVolume; video.currentTime = 0;
                video.removeAttribute('controls'); video.controls = false;
                const checkProgress = () => {
                    if (video.duration - video.currentTime <= 1.111 && video.duration > 0) {
                        showIllusionaryTitle(); video.removeEventListener('timeupdate', checkProgress);
                    }
                };
                video.addEventListener('timeupdate', checkProgress);
                try { await video.play(); } catch (err) { video.onended(); }
            }, 50);
            video.onended = () => {
                cinematicOverlay.style.opacity = '0';
                setTimeout(() => {
                    cinematicOverlay.style.display = 'none';
                    document.querySelectorAll('#ui-hud, #ui-bottom, #grid-container').forEach(el => el.classList.remove('ui-hidden'));
                    bgm.play().catch(() => {}); isCinematicPlaying = false;
                }, 500);
            };
        }

        function clearDisplay() {
            const dw = document.getElementById('display-window'), oc = document.getElementById('odds-container');
            dw.classList.add('opacity-0', 'scale-95'); dw.classList.remove('opacity-100', 'scale-100');
            oc.classList.add('opacity-0'); oc.classList.remove('opacity-100');
            if (flickerInterval) { clearInterval(flickerInterval); flickerInterval = null; }
            isShowingIllusionary = false;
        }

        function showIllusionaryTitle() {
            const mainOutput = document.getElementById('main-output'), oddsContainer = document.getElementById('odds-container'), displayWindow = document.getElementById('display-window');
            isShowingIllusionary = true;
            mainOutput.innerHTML = "illusionary".split('').map(char => `<span class="flicker-char">${char}</span>`).join('');
            mainOutput.className = "text-3xl md:text-7xl illusionary-relic w-full";
            oddsContainer.classList.remove('opacity-0'); oddsContainer.classList.add('opacity-100');
            if (flickerInterval) clearInterval(flickerInterval);
            flickerInterval = setInterval(() => {
                const chars = mainOutput.querySelectorAll('.flicker-char');
                chars.forEach(c => c.classList.remove('flicker-white'));
                const rand = Math.floor(Math.random() * chars.length);
                if (chars[rand]) chars[rand].classList.add('flicker-white');
            }, 350);
            displayWindow.className = "opacity-100 transform scale-100 transition-all duration-300 w-full";
            illusionarySFX.currentTime = 0; illusionarySFX.volume = sfxVolume; illusionarySFX.play().catch(() => {});
            
            const flash = document.getElementById('flash'); 
            flash.classList.remove('glitch-flash', 'trans-flash'); 
            void flash.offsetWidth; 
            flash.classList.add('glitch-flash');
        }

        function getHitCount(n, p) {
            if (n < 500) {
                let c = 0; for (let i = 0; i < n; i++) if (Math.random() < p) c++;
                return c;
            }
            const lambda = n * p;
            if (lambda < 30) {
                let L = Math.exp(-lambda), k = 0, p_val = 1;
                do { k++; p_val *= Math.random(); } while (p_val > L);
                return k - 1;
            }
            const stdDev = Math.sqrt(lambda);
            const u1 = Math.random(), u2 = Math.random();
            const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
            return Math.max(0, Math.floor(z0 * stdDev + lambda));
        }

        function runSim(count, potionType = null) {
            if (isCinematicPlaying && isCinematicEnabled) return;
            if (isShowingIllusionary) clearDisplay();
            
            if (count > 1) {
                const newHits = getHitCount(count, 1/ODDS);
                if (newHits > 0) {
                    let hitRolls = [];
                    for(let i=0; i<newHits; i++) hitRolls.push(rolls + Math.floor(Math.random() * count));
                    hitRolls.sort((a,b) => a - b);
                    
                    hitRolls.forEach(rollAt => {
                        hits += 1;
                        addLogEntry(hits, rollAt);
                    });

                    rolls += count;
                    document.getElementById('rolls-display').innerText = rolls.toLocaleString();
                    document.getElementById('hits-display').innerText = hits.toLocaleString();
                    triggerCinematic();
                } else {
                    rolls += count;
                    document.getElementById('rolls-display').innerText = rolls.toLocaleString();
                    const flash = document.getElementById('flash'); 
                    flash.classList.remove('glitch-flash', 'trans-flash'); 
                    void flash.offsetWidth; 
                    flash.classList.add(potionType === 'trans' ? 'trans-flash' : 'glitch-flash');
                }
            } else {
                rolls += 1;
                document.getElementById('rolls-display').innerText = rolls.toLocaleString();
                if (Math.random() < 1/ODDS) {
                    hits += 1;
                    document.getElementById('hits-display').innerText = hits.toLocaleString();
                    addLogEntry(hits, rolls);
                    triggerCinematic();
                } else if (!isAutoRolling) {
                    const flash = document.getElementById('flash'); 
                    flash.classList.remove('glitch-flash', 'trans-flash'); 
                    void flash.offsetWidth; 
                    flash.classList.add('glitch-flash');
                }
            }
        }

        function toggleAutoRoll() {
            isAutoRolling = !isAutoRolling;
            const btn = document.getElementById('auto-roll-btn'), status = document.getElementById('auto-status'), led = document.getElementById('auto-led');
            if (isAutoRolling) {
                btn.classList.add('active'); status.innerText = "Enabled";
                status.classList.replace('text-white/40', 'text-green-400');
                led.className = "w-2 md:w-3 h-2 md:h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
                autoRollInterval = setInterval(() => runSim(1), 50);
            } else {
                btn.classList.remove('active'); status.innerText = "Disabled";
                status.classList.replace('text-green-400', 'text-white/40');
                led.className = "w-2 md:w-3 h-2 md:h-3 rounded-full bg-slate-700 shadow-none";
                clearInterval(autoRollInterval);
            }
        }

        function handleCustomRoll() {
            let val = parseInt(document.getElementById('custom-roll-amount').value);
            if (!isNaN(val) && val > 0) runSim(Math.min(val, 150000000));
        }

        function updateSFXVolume(v) { sfxVolume = v/100; illusionarySFX.volume = sfxVolume; video.volume = sfxVolume; }
        function updateBGMVolume(v) { bgmVolume = v/100; bgm.volume = bgmVolume; }
        function resetProgress() {
            rolls = 0; hits = 0; if (isAutoRolling) toggleAutoRoll();
            logEntries = []; rollLog.innerHTML = '';
            document.getElementById('rolls-display').innerText = "0"; document.getElementById('hits-display').innerText = "0"; clearDisplay();
        }

        window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'r') resetProgress(); });

        const container = document.getElementById('grid-container');
        setInterval(() => {
            if (document.hidden || isCinematicPlaying) return;
            const d = document.createElement('div');
            d.className = 'digit'; d.innerText = Math.round(Math.random());
            d.style.left = Math.random() * 100 + 'vw';
            container.appendChild(d);
            setTimeout(() => d.remove(), 4000);
        }, 150);

        window.addEventListener('mousedown', unlockMedia);
        window.addEventListener('touchstart', unlockMedia);

        // Load user on page load
        loadUserFromStorage();
    </script>
</body>
</html>
